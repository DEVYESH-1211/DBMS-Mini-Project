<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Events - EMS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --primary: #2b78e4;
      --danger: #d9534f;
      --glass-bg: rgba(255,255,255,0.45);
      --glass-border: rgba(255,255,255,0.35);
      --panel-width: 280px; /* medium */
      --shadow: 0 8px 30px rgba(12,20,30,0.12);
    }

    html,body {height:100%; margin:0; font-family: Arial, Helvetica, sans-serif; background:#f4f6fb;}
    .container { max-width:1000px; margin:20px auto; padding:0 16px; }
    /* top bar */
    .topbar { display:flex; align-items:center; gap:12px; margin-bottom:14px; }
    .hamburger {
      width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:8px; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      cursor:pointer; border:none; font-size:20px;
    }
    .page-title { flex:1; font-size:20px; font-weight:600; margin:0; text-align:center; }

    /* events grid */
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px; margin-top:6px; }
    .card { background:white; border-radius:8px; padding:14px; box-shadow:0 4px 12px rgba(0,0,0,0.06); }
    .card h3 { margin:0 0 8px 0; font-size:18px; }
    .muted { color:#666; font-size:13px; margin-bottom:8px; }
    .muted-small { color:#777; font-size:12px; }
    .btn { padding:8px 12px; border-radius:6px; border: none; cursor:pointer; background:var(--primary); color:white; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    .success-box { display:none; background:#e6ffed; color:#1b7f3a; padding:10px 12px; border-radius:6px; margin-bottom:12px; border:1px solid #c3f1d1; }

    /* modal (register confirm) */
    .modal-back { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); justify-content:center; align-items:center; z-index:120; }
    .modal { background:white; padding:18px; border-radius:8px; width:320px; box-shadow:0 8px 30px rgba(0,0,0,0.2); }
    .modal .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

    /* slide panel (glass) */
    .panel-backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,0.28); opacity:0; pointer-events:none;
      transition: opacity 260ms ease; z-index:200;
    }
    .panel-backdrop.open { opacity:1; pointer-events:auto; }

    .side-panel {
      position:fixed;
      left: calc(-1 * var(--panel-width));
      top:0;
      height:100%;
      width: var(--panel-width);
      padding:18px;
      box-sizing:border-box;
      border-top-right-radius:12px;
      border-bottom-right-radius:12px;
      box-shadow: var(--shadow);
      transition: left 300ms cubic-bezier(.2,.9,.25,1);
      z-index:210;

      /* Glassmorphism */
      background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.40));
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
    }
    .side-panel.open { left:0; }

    .panel-header { font-weight:700; font-size:18px; margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .panel-section { margin-top:10px; }

    .logout-btn {
      background: var(--danger);
      color:white;
      padding:10px 14px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      width:100%;
      font-size:15px;
    }
    .logout-btn:active { transform:translateY(1px); }

    /* small helper */
    .panel-sub { color:#444; font-size:13px; margin-bottom:8px; opacity:0.9; }

    /* responsive tweaks */
    @media (max-width:520px){
      .page-title { font-size:18px; }
      :root { --panel-width: 86%; } /* on small screens panel takes more width */
    }
  </style>
</head>
<body>
  <!-- Slide panel backdrop (click to close) -->
  <div id="panelBackdrop" class="panel-backdrop" aria-hidden="true"></div>

  <!-- Side panel -->
  <aside id="sidePanel" class="side-panel" aria-hidden="true" role="navigation" aria-label="Menu panel">
    <div class="panel-header">
      <div>MENU</div>
      <button id="panelClose" title="Close" style="background:transparent;border:none;font-size:18px;cursor:pointer;">✕</button>
    </div>

    <div class="panel-section">
      <div class="panel-sub">Welcome!</div>
      <!-- add more items here later -->
    </div>

    <div class="panel-section" style="margin-top:22px;">
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </aside>

  <div class="container">
    <div class="topbar">
      <button id="hamburger" class="hamburger" aria-label="Open menu">☰</button>
      <h1 class="page-title">Events</h1>
      <!-- spacing element to keep title centered when hamburger present -->
      <div style="width:44px; height:44px;"></div>
    </div>

    <div id="successBox" class="success-box" role="status" aria-live="polite">Registered successfully!</div>

    <div id="grid" class="grid" aria-live="polite"></div>
  </div>

  <!-- Modal -->
  <div id="modalBack" class="modal-back" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div id="modalText">Are you sure you want to register?</div>
      <div class="actions">
        <button id="modalCancel" class="btn">Cancel</button>
        <button id="modalConfirm" class="btn">Yes, Register</button>
      </div>
    </div>
  </div>

  <script>
    /***** Panel logic *****/
    const panel = document.getElementById('sidePanel');
    const backdrop = document.getElementById('panelBackdrop');
    const hamburger = document.getElementById('hamburger');
    const panelClose = document.getElementById('panelClose');
    const logoutBtn = document.getElementById('logoutBtn');


    function openPanel() {
      panel.classList.add('open');
      panel.setAttribute('aria-hidden', 'false');
      backdrop.classList.add('open');
      backdrop.setAttribute('aria-hidden', 'false');
      // trap focus could be added later
    }
    function closePanel() {
      panel.classList.remove('open');
      panel.setAttribute('aria-hidden', 'true');
      backdrop.classList.remove('open');
      backdrop.setAttribute('aria-hidden', 'true');
    }

    hamburger.addEventListener('click', openPanel);
    panelClose.addEventListener('click', closePanel);
    backdrop.addEventListener('click', closePanel);

    // keyboard: Esc closes panel
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePanel();
    });

    // Logout behavior (client-side call). If you have a /logout endpoint, it will call it.
    logoutBtn.addEventListener('click', () => {
      // Provide a small confirmation inside panel to avoid accidental logout
      if (!confirm('Logout and return to login?')) return;

      // Try to POST /logout (best practice). If not available, fallback to redirect to /login
      fetch('/logout', { method: 'POST', credentials: 'same-origin' })
        .then(res => {
          // If logout endpoint exists and redirects, follow redirect
          window.location.href = '/login';
        })
        .catch(() => {
          // fallback
          window.location.href = '/login';
        });
    });

    /***** Events & registration logic (keeps original behavior) *****/
    let events = [];
    let currentEventId = null;
    let currentButton = null;

    function showSuccess(msg) {
      const box = document.getElementById('successBox');
      box.textContent = msg;
      box.style.display = 'block';
      setTimeout(() => { box.style.display = 'none'; }, 3000);
    }

    function fetchEvents() {
      // If you want a local sample fallback when server not present:
      fetch('/events-data')
        .then(r => r.json())
        .then(data => {
          events = data || [];
          render();
        })
        .catch(err => {
          console.warn('events-data fetch failed, using local sample events', err);
          // SAMPLE fallback so page remains usable offline
          events = [
            { id: 1, event_name: 'Orientation Day', event_date: '2025-11-05', venue: 'Auditorium', reg_fee: 0, reg_close_date: '2025-11-03', max_participants: 200 },
            { id: 2, event_name: 'Coding Hackathon', event_date: '2025-12-12', venue: 'Lab 3', reg_fee: 50, reg_close_date: '2025-12-10', max_participants: 100 }
          ];
          render();
        });
    }

    function render() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      if (!events.length) {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666; padding:18px; background:#fff; border-radius:8px;">No events available.</div>';
        return;
      }

      events.forEach(ev => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${escapeHtml(ev.event_name)}</h3>
          <div class="muted">${ev.event_date} • ${escapeHtml(ev.venue)}</div>
          <div class="muted-small">Fee: ₹${ev.reg_fee} • Closes: ${ev.reg_close_date} • Max: ${ev.max_participants}</div>
          <div style="margin-top:12px;">
            <button class="btn register-btn" data-id="${ev.id}">Register</button>
          </div>
        `;
        grid.appendChild(card);
      });

      // attach handlers
      document.querySelectorAll('.register-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          currentButton = e.currentTarget;
          currentEventId = currentButton.getAttribute('data-id');
          openModal(currentButton);
        });
      });
    }

    function openModal(btn) {
      const ev = events.find(x => String(x.id) === String(currentEventId));
      if (!ev) return;
      const text = `Are you sure you want to register for "${ev.event_name}"?`;
      document.getElementById('modalText').textContent = text;
      document.getElementById('modalBack').style.display = 'flex';
      document.getElementById('modalBack').setAttribute('aria-hidden', 'false');
    }

    document.getElementById('modalCancel').addEventListener('click', () => {
      document.getElementById('modalBack').style.display = 'none';
      document.getElementById('modalBack').setAttribute('aria-hidden', 'true');
      currentEventId = null;
      currentButton = null;
    });

    document.getElementById('modalConfirm').addEventListener('click', () => {
      if (!currentEventId) return;
      fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'event_id=' + encodeURIComponent(currentEventId),
        credentials: 'same-origin'
      })
      .then(async res => {
        document.getElementById('modalBack').style.display = 'none';
        document.getElementById('modalBack').setAttribute('aria-hidden', 'true');

        if (res.status === 200) {
          showSuccess('Registered successfully!');
          if (currentButton) {
            currentButton.textContent = 'Registered ✅';
            currentButton.disabled = true;
          }
        } else if (res.status === 409) {
          showSuccess('Already registered');
          if (currentButton) {
            currentButton.textContent = 'Registered ✅';
            currentButton.disabled = true;
          }
        } else if (res.status === 401) {
          alert('Please login first to register.');
          window.location.href = '/login';
        } else {
          const txt = await res.text();
          alert('Error: ' + txt);
        }
      })
      .catch(err => {
        console.error(err);
        alert('Network error');
      })
      .finally(() => {
        currentEventId = null;
        currentButton = null;
      });
    });

    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // initial load
    fetchEvents();
  </script>
</body>
</html>
